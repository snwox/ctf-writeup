// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test, console} from "forge-std/Test.sol";
import {USDS,USDC,WETH,SafeMoon,Setup,USDSEngine} from "src/core/Setup.sol";
import {IBi0sSwapFactory} from "src/bi0s-swap-v1/interfaces/IBi0sSwapFactory.sol";
import {IBi0sSwapPair} from "src/bi0s-swap-v1/interfaces/IBi0sSwapPair.sol";
import {IBi0sSwapCalle} from "src/bi0s-swap-v1/interfaces/IBi0sSwapCalle.sol";

contract Bi0sSwapPoolsDeployHelper{
    IBi0sSwapFactory public bi0sSwapFactory;
    Setup public setup;

    IBi0sSwapPair public wethUsdcPair;
    IBi0sSwapPair public wethSafeMoonPair;
    IBi0sSwapPair public safeMoonUsdcPair;

    constructor(address _bi0sSwapFactory,address _setup){
        bi0sSwapFactory=IBi0sSwapFactory(_bi0sSwapFactory);
        setup=Setup(_setup);
        address usdc=address(setup.usdc());
        address safeMoon=address(setup.safeMoon());
        address weth=address(setup.weth());

        wethUsdcPair=IBi0sSwapPair(bi0sSwapFactory.createPair(weth, usdc));
        wethSafeMoonPair=IBi0sSwapPair(bi0sSwapFactory.createPair(weth, safeMoon));
        safeMoonUsdcPair=IBi0sSwapPair(bi0sSwapFactory.createPair(safeMoon, usdc));
    }

}

contract Exploiter is IBi0sSwapCalle{
    Setup setup;
    WETH weth;
    USDC usdc;
    SafeMoon safeMoon;
    address wethSafeMoonPair;
    address wethUsdcPair;
    address safeMoonUsdcPair;
    USDSEngine usdsEngine;
    constructor(Setup _setup) payable {
        setup = _setup;
        weth = _setup.weth();
        usdc = _setup.usdc();
        safeMoon = _setup.safeMoon();
        wethSafeMoonPair = address(_setup.wethSafeMoonPair());
        wethUsdcPair = address(_setup.wethUsdcPair());
        safeMoonUsdcPair = address(_setup.safeMoonUsdcPair());
        usdsEngine = _setup.usdsEngine();

        _setup.setPlayer(address(this));
    }

    function exploit() external {
        weth.deposit{value: 80000 ether}(address(this));

        weth.approve(wethSafeMoonPair, 80000 ether);
        IBi0sSwapPair(wethSafeMoonPair).swap(address(weth), 80000 ether, address(this), "safeMoon");

        console.log("usdc balance", usdc.balanceOf(address(this)));
        console.log("safeMoon balacne", safeMoon.balanceOf(address(this)));
        console.log("weth balance", weth.balanceOf(address(this)));
        
    }
    function bi0sSwapv1Call(address sender,address outputToken,uint256 amountOut,bytes memory data) external {
        if(keccak256(data)==keccak256("weth")) {
        
        }
    }
    receive() external payable{}
}
/*
*/

contract CounterTest is Test {
    function testSolve() public {
        address deployer = makeAddr("deployer");
        address player = makeAddr("player");

        address bi0sSwapFactory = createFactory();
        vm.deal(player, 80001e18);

        vm.startPrank(deployer);
        uint256 WETH_INITIAL_MINT=225539152795198000*2e18;
        vm.deal(deployer, WETH_INITIAL_MINT);
        Setup setup=new Setup{value:WETH_INITIAL_MINT}();
        Bi0sSwapPoolsDeployHelper bi0sSwapPoolCreator=new Bi0sSwapPoolsDeployHelper(bi0sSwapFactory,address(setup));
        setup.initialize(address(bi0sSwapPoolCreator), bi0sSwapFactory);
        vm.stopPrank();

        vm.startPrank(player);
        Exploiter exploiter = new Exploiter{value: 80_000 ether}(setup);
        exploiter.exploit();
        vm.stopPrank();
    }

    function createFactory() internal returns (address bi0sSwapFactory) {
        bi0sSwapFactory = address(uint160(uint256(keccak256(abi.encodePacked(hex"d6_94", msg.sender, hex"80")))));
        bytes memory factoryCode = hex"608060405234801561001057600080fd5b50600436106100575760003560e01c80631e3dd18b1461005c57806352c7420d14610095578063574f2ba3146100af578063c9c65396146100b7578063e6a43905146100e5575b600080fd5b6100796004803603602081101561007257600080fd5b5035610113565b604080516001600160a01b039092168252519081900360200190f35b61009d61013a565b60408051918252519081900360200190f35b61009d610170565b610079600480360360408110156100cd57600080fd5b506001600160a01b0381358116916020013516610176565b610079600480360360408110156100fb57600080fd5b506001600160a01b03813581169160200135166104a1565b6001818154811061012057fe5b6000918252602090912001546001600160a01b0316905081565b600060606040518060200161014e906104c4565b601f1982820381018352601f9091011660405280516020919091012091505090565b60015490565b6000816001600160a01b0316836001600160a01b031614156101df576040805162461bcd60e51b815260206004820152601e60248201527f556e697377617056323a204944454e544943414c5f4144445245535345530000604482015290519081900360640190fd5b600080836001600160a01b0316856001600160a01b031610610202578385610205565b84845b90925090506001600160a01b038216610265576040805162461bcd60e51b815260206004820152601760248201527f556e697377617056323a205a45524f5f41444452455353000000000000000000604482015290519081900360640190fd5b6001600160a01b03828116600090815260208181526040808320858516845290915290205416156102d6576040805162461bcd60e51b8152602060048201526016602482015275556e697377617056323a20504149525f45584953545360501b604482015290519081900360640190fd5b6060604051806020016102e8906104c4565b6020820181038252601f19601f8201166040525090506000838360405160200180836001600160a01b031660601b8152601401826001600160a01b031660601b815260140192505050604051602081830303815290604052805190602001209050808251602084016000f59450846001600160a01b031663485cc95585856040518363ffffffff1660e01b815260040180836001600160a01b03168152602001826001600160a01b0316815260200192505050600060405180830381600087803b1580156103b557600080fd5b505af11580156103c9573d6000803e3d6000fd5b5050506001600160a01b038086166000818152602081815260408083208986168085529083528184208054968d166001600160a01b0319978816811790915584845282852086865284528285208054881682179055600180548082018255958190527fb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6909501805490971681179096559254815195865291850191909152805191945091927f0d3648bd0f6ba80134a33ba9275ac585d9d315f0ad8355cddefde31afa28d0e992908290030190a35050505092915050565b60006020818152928152604080822090935290815220546001600160a01b031681565b611a74806104d28339019056fe60806040523480156200001157600080fd5b50604080518082018252600c81526b426930732d537761702d563160a01b6020808301918252835180850190945260048452636269307360e01b9084015281519192916200006291600391620000a0565b50805162000078906004906020840190620000a0565b50506005805460ff1916601217905550600980546001600160a01b031916331790556200013c565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620000e357805160ff191683800117855562000113565b8280016001018555821562000113579182015b8281111562000113578251825591602001919060010190620000f6565b506200012192915062000125565b5090565b5b8082111562000121576000815560010162000126565b611928806200014c6000396000f3fe608060405234801561001057600080fd5b50600436106101425760003560e01c806370a08231116100b8578063a9059cbb1161007c578063a9059cbb1461046e578063c45a01551461049a578063d21220a7146104a2578063d798f86e146104aa578063dd62ed3e146104d0578063e3412e3d146104fe57610142565b806370a08231146103235780637f0f41d714610349578063903becfb1461040e57806395d89b411461043a578063a457c2d71461044257610142565b806323b872dd1161010a57806323b872dd14610263578063313ce5671461029957806339509351146102b7578063443cb4bc146102e3578063485cc955146102eb5780635a76f25e1461031b57610142565b806306fdde03146101475780630902f1ac146101c4578063095ea7b3146101e55780630dfe16811461022557806318160ddd14610249575b600080fd5b61014f610524565b6040805160208082528351818301528351919283929083019185019080838360005b83811015610189578181015183820152602001610171565b50505050905090810190601f1680156101b65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101cc6105ba565b6040805192835260208301919091528051918290030190f35b610211600480360360408110156101fb57600080fd5b506001600160a01b0381351690602001356105c4565b604080519115158252519081900360200190f35b61022d6105e1565b604080516001600160a01b039092168252519081900360200190f35b6102516105f5565b60408051918252519081900360200190f35b6102116004803603606081101561027957600080fd5b506001600160a01b038135811691602081013590911690604001356105fb565b6102a1610683565b6040805160ff9092168252519081900360200190f35b610211600480360360408110156102cd57600080fd5b506001600160a01b03813516906020013561068c565b6102516106da565b6103196004803603604081101561030157600080fd5b506001600160a01b03813581169160200135166106e0565b005b610251610766565b6102516004803603602081101561033957600080fd5b50356001600160a01b031661076c565b6103196004803603608081101561035f57600080fd5b6001600160a01b03823581169260208101359260408201359092169181019060808101606082013564010000000081111561039957600080fd5b8201836020820111156103ab57600080fd5b803590602001918460018302840111640100000000831117156103cd57600080fd5b91908080601f01602080910402602001604051908101604052809392919081815260200183838082843760009201919091525092955061078b945050505050565b6102516004803603604081101561042457600080fd5b506001600160a01b038135169060200135610b56565b61014f610bf2565b6102116004803603604081101561045857600080fd5b506001600160a01b038135169060200135610c53565b6102116004803603604081101561048457600080fd5b506001600160a01b038135169060200135610cbb565b61022d610ccf565b61022d610cde565b610319600480360360208110156104c057600080fd5b50356001600160a01b0316610ced565b610251600480360360408110156104e657600080fd5b506001600160a01b0381358116916020013516610e4c565b6102516004803603602081101561051457600080fd5b50356001600160a01b0316610e77565b60038054604080516020601f60026000196101006001881615020190951694909404938401819004810282018101909252828152606093909290918301828280156105b05780601f10610585576101008083540402835291602001916105b0565b820191906000526020600020905b81548152906001019060200180831161059357829003601f168201915b5050505050905090565b6007546008549091565b60006105d86105d1611014565b8484611018565b50600192915050565b60055461010090046001600160a01b031681565b60025490565b6000610608848484611104565b61067884610614611014565b6106738560405180606001604052806028815260200161183c602891396001600160a01b038a16600090815260016020526040812090610652611014565b6001600160a01b03168152602081019190915260400160002054919061125f565b611018565b5060015b9392505050565b60055460ff1690565b60006105d8610699611014565b8461067385600160006106aa611014565b6001600160a01b03908116825260208083019390935260409182016000908120918c1681529252902054906112f6565b60075481565b6009546001600160a01b0316331461072e576040805162461bcd60e51b815260206004820152600c60248201526b4f6e6c7920466163746f727960a01b604482015290519081900360640190fd5b60058054610100600160a81b0319166101006001600160a01b0394851602179055600680546001600160a01b03191691909216179055565b60085481565b6001600160a01b0381166000908152602081905260409020545b919050565b600954600160a01b900460ff16156107e2576040805162461bcd60e51b8152602060048201526015602482015274149151539514905390d648141493d2125092551151605a1b604482015290519081900360640190fd5b6009805460ff60a01b1916600160a01b1790556005546001600160a01b03858116610100909204161480159061082657506006546001600160a01b03858116911614155b1561086b576040805162461bcd60e51b815260206004820152601060248201526f24b73b30b634b2102a37b5b2b71024b760811b604482015290519081900360640190fd5b6005546001600160a01b03858116610100909204161460008161089e5760055461010090046001600160a01b03166108ab565b6006546001600160a01b03165b90506000826108bc576008546108c0565b6007545b90506000836108d1576007546108d5565b6008545b604080516323b872dd60e01b8152336004820152306024820152604481018a905290519192506001600160a01b038a16916323b872dd916064808201926020929091908290030181600087803b15801561092e57600080fd5b505af1158015610942573d6000803e3d6000fd5b505050506040513d602081101561095857600080fd5b506000905061096a83838a8201611350565b90508082038281106109bc576040805162461bcd60e51b8152602060048201526016602482015275496e73756666696369656e74206c697175696469747960501b604482015290519081900360640190fd5b846001600160a01b031663a9059cbb89836040518363ffffffff1660e01b815260040180836001600160a01b0316815260200182815260200192505050602060405180830381600087803b158015610a1357600080fd5b505af1158015610a27573d6000803e3d6000fd5b505050506040513d6020811015610a3d57600080fd5b50508651883b9015610b3457886001600160a01b031663389bc44f3388858c6040518563ffffffff1660e01b815260040180856001600160a01b03168152602001846001600160a01b0316815260200183815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610acc578181015183820152602001610ab4565b50505050905090810190601f168015610af95780820380516001836020036101000a031916815260200191505b5095505050505050600060405180830381600087803b158015610b1b57600080fd5b505af1158015610b2f573d6000803e3d6000fd5b505050505b610b3c6113ff565b50506009805460ff60a01b19169055505050505050505050565b600554600090819081906001600160a01b03868116610100909204161415610b85575050600754600854610b8e565b50506008546007545b808410610bd5576040805162461bcd60e51b815260206004820152601060248201526f4f757470757420746f6f206c6172676560801b604482015290519081900360640190fd5b610be98285610be484826114f9565b611350565b95945050505050565b60048054604080516020601f60026000196101006001881615020190951694909404938401819004810282018101909252828152606093909290918301828280156105b05780601f10610585576101008083540402835291602001916105b0565b60006105d8610c60611014565b84610673856040518060600160405280602581526020016118ce6025913960016000610c8a611014565b6001600160a01b03908116825260208083019390935260409182016000908120918d1681529252902054919061125f565b60006105d8610cc8611014565b8484611104565b6009546001600160a01b031681565b6006546001600160a01b031681565b6000610cf83061076c565b90506000610d046105f5565b90506000610d158360075484611350565b90506000610d268460085485611350565b9050610d323085611556565b6005546040805163a9059cbb60e01b81526001600160a01b0388811660048301526024820186905291516101009093049091169163a9059cbb916044808201926020929091908290030181600087803b158015610d8e57600080fd5b505af1158015610da2573d6000803e3d6000fd5b505050506040513d6020811015610db857600080fd5b50506006546040805163a9059cbb60e01b81526001600160a01b038881166004830152602482018590529151919092169163a9059cbb9160448083019260209291908290030181600087803b158015610e1057600080fd5b505af1158015610e24573d6000803e3d6000fd5b505050506040513d6020811015610e3a57600080fd5b50610e4590506113ff565b5050505050565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b600080600560019054906101000a90046001600160a01b03166001600160a01b03166370a08231306040518263ffffffff1660e01b815260040180826001600160a01b0316815260200191505060206040518083038186803b158015610edc57600080fd5b505afa158015610ef0573d6000803e3d6000fd5b505050506040513d6020811015610f0657600080fd5b5051600654604080516370a0823160e01b815230600482015290519293506000926001600160a01b03909216916370a0823191602480820192602092909190829003018186803b158015610f5957600080fd5b505afa158015610f6d573d6000803e3d6000fd5b505050506040513d6020811015610f8357600080fd5b5051905060008080610f936105f5565b905080610fac57610fa5848602611652565b9550610ff8565b600754610fba9086906114f9565b9250610fd1600854856114f990919063ffffffff16565b9150610ff5610fe38483600754611350565b610ff08484600854611350565b6116a3565b95505b61100287876116b9565b61100a6113ff565b5050505050919050565b3390565b6001600160a01b03831661105d5760405162461bcd60e51b81526004018080602001828103825260248152602001806118aa6024913960400191505060405180910390fd5b6001600160a01b0382166110a25760405162461bcd60e51b81526004018080602001828103825260228152602001806117f46022913960400191505060405180910390fd5b6001600160a01b03808416600081815260016020908152604080832094871680845294825291829020859055815185815291517f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9259281900390910190a3505050565b6001600160a01b0383166111495760405162461bcd60e51b81526004018080602001828103825260258152602001806118856025913960400191505060405180910390fd5b6001600160a01b03821661118e5760405162461bcd60e51b81526004018080602001828103825260238152602001806117af6023913960400191505060405180910390fd5b6111998383836117a9565b6111d681604051806060016040528060268152602001611816602691396001600160a01b038616600090815260208190526040902054919061125f565b6001600160a01b03808516600090815260208190526040808220939093559084168152205461120590826112f6565b6001600160a01b038084166000818152602081815260409182902094909455805185815290519193928716927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef92918290030190a3505050565b600081848411156112ee5760405162461bcd60e51b81526004018080602001828103825283818151815260200191508051906020019080838360005b838110156112b357818101518382015260200161129b565b50505050905090810190601f1680156112e05780820380516001836020036101000a031916815260200191505b509250505060405180910390fd5b505050900390565b60008282018381101561067c576040805162461bcd60e51b815260206004820152601b60248201527f536166654d6174683a206164646974696f6e206f766572666c6f770000000000604482015290519081900360640190fd5b6000808060001985870986860292508281109083900303905080611386576000841161137b57600080fd5b50829004905061067c565b80841161139257600080fd5b6000848688096000868103871696879004966002600389028118808a02820302808a02820302808a02820302808a02820302808a02820302808a02909103029181900381900460010186841190950394909402919094039290920491909117919091029150509392505050565b600554604080516370a0823160e01b815230600482015290516101009092046001600160a01b0316916370a0823191602480820192602092909190829003018186803b15801561144e57600080fd5b505afa158015611462573d6000803e3d6000fd5b505050506040513d602081101561147857600080fd5b5051600755600654604080516370a0823160e01b815230600482015290516001600160a01b03909216916370a0823191602480820192602092909190829003018186803b1580156114c857600080fd5b505afa1580156114dc573d6000803e3d6000fd5b505050506040513d60208110156114f257600080fd5b5051600855565b600082821115611550576040805162461bcd60e51b815260206004820152601e60248201527f536166654d6174683a207375627472616374696f6e206f766572666c6f770000604482015290519081900360640190fd5b50900390565b6001600160a01b03821661159b5760405162461bcd60e51b81526004018080602001828103825260218152602001806118646021913960400191505060405180910390fd5b6115a7826000836117a9565b6115e4816040518060600160405280602281526020016117d2602291396001600160a01b038516600090815260208190526040902054919061125f565b6001600160a01b03831660009081526020819052604090205560025461160a90826114f9565b6002556040805182815290516000916001600160a01b038516917fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9181900360200190a35050565b60006003821115611695575080600160028204015b8181101561168f5780915060028182858161167e57fe5b04018161168757fe5b049050611667565b50610786565b811561078657506001919050565b60008183106116b2578161067c565b5090919050565b6001600160a01b038216611714576040805162461bcd60e51b815260206004820152601f60248201527f45524332303a206d696e7420746f20746865207a65726f206164647265737300604482015290519081900360640190fd5b611720600083836117a9565b60025461172d90826112f6565b6002556001600160a01b03821660009081526020819052604090205461175390826112f6565b6001600160a01b0383166000818152602081815260408083209490945583518581529351929391927fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9281900390910190a35050565b50505056fe45524332303a207472616e7366657220746f20746865207a65726f206164647265737345524332303a206275726e20616d6f756e7420657863656564732062616c616e636545524332303a20617070726f766520746f20746865207a65726f206164647265737345524332303a207472616e7366657220616d6f756e7420657863656564732062616c616e636545524332303a207472616e7366657220616d6f756e74206578636565647320616c6c6f77616e636545524332303a206275726e2066726f6d20746865207a65726f206164647265737345524332303a207472616e736665722066726f6d20746865207a65726f206164647265737345524332303a20617070726f76652066726f6d20746865207a65726f206164647265737345524332303a2064656372656173656420616c6c6f77616e63652062656c6f77207a65726fa2646970667358221220d9bc342a4271e3888b039301a31f4cd4e3f7f14f459d64f49772807e9ed8ea1f64736f6c634300060c0033a26469706673582212200f0965bbad37d92b0c15dfce2a5095bd6076f7ebb7e7abac89d1fea96804c3f964736f6c634300060c0033";
        vm.etch(bi0sSwapFactory, factoryCode);
    }
}